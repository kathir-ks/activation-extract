WARNING:root:libtpu.so and TPU device found. Setting PJRT_DEVICE=TPU.
======================================================================
DISTRIBUTED ARC-AGI INFERENCE WITH ACTIVATION EXTRACTION
======================================================================
{
  "output_filepath": "test_outputs/production_predictions.json",
  "activations_dir": "test_activations/production_run_20251005_165919",
  "model_path": "KathirKs/qwen-2.5-0.5b",
  "max_model_len": 10240,
  "grid_encoder": "GridShapeEncoder(RowNumberEncoder(MinimalGridEncoder()))",
  "prompt_version": "output-from-examples-v0",
  "dataset_path": "test_data_small.json",
  "n_tasks": 2,
  "max_output_tokens": 500,
  "predictions_per_task": 2,
  "temperature": 0.0,
  "batch_size": 2,
  "random_seed": null,
  "mesh_shape": [
    2,
    2
  ],
  "use_pjit": true,
  "extract_activations": true,
  "layers_to_extract": [
    10,
    11,
    12
  ],
  "save_every_n_batches": 10,
  "upload_to_cloud": false,
  "cloud_bucket": null,
  "verbose": false
}
======================================================================
Found 4 devices: [TpuDevice(id=0, process_index=0, coords=(0,0,0), core_on_chip=0), TpuDevice(id=1, process_index=0, coords=(1,0,0), core_on_chip=0), TpuDevice(id=2, process_index=0, coords=(0,1,0), core_on_chip=0), TpuDevice(id=3, process_index=0, coords=(1,1,0), core_on_chip=0)]
Created mesh with shape [2, 2]: Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto))
Loaded 2 tasks from test_data_small.json

Loading tokenizer from KathirKs/qwen-2.5-0.5b...
Creating model with activation hooks for layers [10, 11, 12]...
Loading model weights from KathirKs/qwen-2.5-0.5b...

Sharding model across 4 devices using mesh...
Target devices: ['TPU_0(process=0,(0,0,0,0))', 'TPU_1(process=0,(1,0,0,0))', 'TPU_2(process=0,(0,1,0,0))', 'TPU_3(process=0,(1,1,0,0))']
Mesh axes: data=2, model=2

Verifying parameter sharding:
  ['params']/['embed_tokens']/['embedding']: shape=(151936, 896), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)
  ['params']/['layers_0']/['input_layernorm']/['weight']: shape=(896,), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None,), memory_kind=device)
  ['params']/['layers_0']/['mlp']/['down_proj']/['kernel']: shape=(4864, 896), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)

Creating prompts for 2 tasks...
Creating prompts:   0%|          | 0/2 [00:00<?, ?it/s]Creating prompts: 100%|██████████| 2/2 [00:00<00:00, 97.03it/s]
Created 3 prompts
Tokenizing prompts...
Tokenizing:   0%|          | 0/3 [00:00<?, ?it/s]Tokenizing: 100%|██████████| 3/3 [00:00<00:00, 56.75it/s]

Distributing data across 4 devices...
Processing 1 batches...
Creating mesh-aware generation function...
Inference batches:   0%|          | 0/1 [00:00<?, ?it/s]Inference batches: 100%|██████████| 1/1 [1:42:07<00:00, 6127.51s/it]Inference batches: 100%|██████████| 1/1 [1:42:07<00:00, 6127.51s/it]

Sharding verification:
  Input shape: (8, 465)
  Input sharding: NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec('data', None), memory_kind=device)
  Params sharding: NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)
Saved activation metadata to test_activations/production_run_20251005_165919/metadata.json

Creating solutions from 8 predictions...

Sample predictions (first 2):
  Prediction 0: task_id=test_task_001, idx=0
    Text (first 200 chars): Human
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
``
  Prediction 1: task_id=test_task_001, idx=0
    Text (first 200 chars):  shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
Warning: Failed to parse 8/8 predictions
Saving predictions to test_outputs/production_predictions.json...

======================================================================
DISTRIBUTED INFERENCE COMPLETE!
Predictions saved to: test_outputs/production_predictions.json
Activations saved to: test_activations/production_run_20251005_165919
======================================================================
	Command being timed: "python distributed_inference_with_activations.py --model_path KathirKs/qwen-2.5-0.5b --dataset_path test_data_small.json --output_filepath test_outputs/production_predictions.json --activations_dir test_activations/production_run_20251005_165919 --batch_size 2 --n_tasks 2 --max_output_tokens 500 --predictions_per_task 2 --grid_encoder GridShapeEncoder(RowNumberEncoder(MinimalGridEncoder())) --prompt_version output-from-examples-v0 --extract_activations --layers_to_extract 10 11 12 --mesh_shape 2 2"
	User time (seconds): 17094.42
	System time (seconds): 374.83
	Percent of CPU this job got: 282%
	Elapsed (wall clock) time (h:mm:ss or m:ss): 1:43:14
	Average shared text size (kbytes): 0
	Average unshared data size (kbytes): 0
	Average stack size (kbytes): 0
	Average total size (kbytes): 0
	Maximum resident set size (kbytes): 76988384
	Average resident set size (kbytes): 0
	Major (requiring I/O) page faults: 346
	Minor (reclaiming a frame) page faults: 64582455
	Voluntary context switches: 30674533
	Involuntary context switches: 27060
	Swaps: 0
	File system inputs: 0
	File system outputs: 10568
	Socket messages sent: 0
	Socket messages received: 0
	Signals delivered: 0
	Page size (bytes): 4096
	Exit status: 0
