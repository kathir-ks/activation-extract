=== Production Run Started at Sun Oct  5 17:05:21 UTC 2025 ===
WARNING:root:libtpu.so and TPU device found. Setting PJRT_DEVICE=TPU.
======================================================================
DISTRIBUTED ARC-AGI INFERENCE WITH ACTIVATION EXTRACTION
======================================================================
{
  "output_filepath": "test_outputs/production_predictions.json",
  "activations_dir": "test_activations/production_run_20251005_170521",
  "model_path": "KathirKs/qwen-2.5-0.5b",
  "max_model_len": 10240,
  "grid_encoder": "GridShapeEncoder(RowNumberEncoder(MinimalGridEncoder()))",
  "prompt_version": "output-from-examples-v0",
  "dataset_path": "test_data_small.json",
  "n_tasks": 2,
  "max_output_tokens": 500,
  "predictions_per_task": 2,
  "temperature": 0.0,
  "batch_size": 2,
  "random_seed": null,
  "mesh_shape": [
    2,
    2
  ],
  "use_pjit": true,
  "extract_activations": true,
  "layers_to_extract": [
    10,
    11,
    12
  ],
  "save_every_n_batches": 10,
  "upload_to_cloud": false,
  "cloud_bucket": null,
  "verbose": false
}
======================================================================
Traceback (most recent call last):
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 742, in backends
    backend = _init_backend(platform)
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 828, in _init_backend
    backend = registration.factory()
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 161, in tpu_client_timer_callback
    client = make_tpu_client(
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 145, in make_tpu_client
    return _jax.get_c_api_client('tpu', options)
jaxlib._jax.XlaRuntimeError: UNKNOWN: TPU initialization failed: open(/dev/accel2): Operation not permitted: Operation not permitted; Couldn't open device: /dev/accel2; [/dev/accel2] 

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/kathirks_gc/torch_xla/qwen/distributed_inference_with_activations.py", line 777, in <module>
    inference_main_distributed()
  File "/home/kathirks_gc/torch_xla/qwen/distributed_inference_with_activations.py", line 560, in inference_main_distributed
    mesh = setup_mesh(cfg.mesh_shape)
  File "/home/kathirks_gc/torch_xla/qwen/distributed_inference_with_activations.py", line 82, in setup_mesh
    devices = jax.devices()
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 942, in devices
    return get_backend(backend).devices()
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 876, in get_backend
    return _get_backend_uncached(platform)
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 855, in _get_backend_uncached
    bs = backends()
  File "/home/kathirks_gc/.local/lib/python3.10/site-packages/jax/_src/xla_bridge.py", line 758, in backends
    rInference batches: 100%|██████████| 1/1 [1:42:07<00:00, 6127.51s/it]Inference batches: 100%|██████████| 1/1 [1:42:07<00:00, 6127.51s/it]

Sharding verification:
  Input shape: (8, 465)
  Input sharding: NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec('data', None), memory_kind=device)
  Params sharding: NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)
Saved activation metadata to test_activations/production_run_20251005_165919/metadata.json

Creating solutions from 8 predictions...

Sample predictions (first 2):
  Prediction 0: task_id=test_task_001, idx=0
    Text (first 200 chars): Human
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
```grid
``
  Prediction 1: task_id=test_task_001, idx=0
    Text (first 200 chars):  shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
### Output

```grid shape: 4x2
1 22
2 22
3 22
4 22
```
Warning: Failed to parse 8/8 predictions
Saving predictions to test_outputs/production_predictions.json...

======================================================================
DISTRIBUTED INFERENCE COMPLETE!
Predictions saved to: test_outputs/production_predictions.json
Activations saved to: test_activations/production_run_20251005_165919
======================================================================
	Command being timed: "python distributed_inference_with_activations.py --model_path KathirKs/qwen-2.5-0.5b --dataset_path test_data_small.json --output_filepath test_outputs/production_predictions.json --activations_dir test_activations/production_run_20251005_165919 --batch_size 2 --n_tasks 2 --max_output_tokens 500 --predictions_per_task 2 --grid_encoder GridShapeEncoder(RowNumberEncoder(MinimalGridEncoder())) --prompt_version output-from-examples-v0 --extract_activations --layers_to_extract 10 11 12 --mesh_shape 2 2"
	User time (seconds): 17094.42
	System time (seconds): 374.83
	Percent of CPU this job got: 282%
	Elapsed (wall clock) time (h:mm:ss or m:ss): 1:43:14
	Average shared text size (kbytes): 0
	Average unshared data size (kbytes): 0
	Average stack size (kbytes): 0
	Average total size (kbytes): 0
	Maximum resident set size (kbytes): 76988384
	Average resident set size (kbytes): 0
	Major (requiring I/O) page faults: 346
	Minor (reclaiming a frame) page faults: 64582455
	Voluntary context switches: 30674533
	Involuntary context switches: 27060
	Swaps: 0
	File system inputs: 0
	File system outputs: 10568
	Socket messages sent: 0
	Socket messages received: 0
	Signals delivered: 0
	Page size (bytes): 4096
	Exit status: 0

=== Production Run Completed at Sun Oct  5 18:42:33 UTC 2025 ===
Total Duration: 6194 seconds (103 minutes)
Total Predictions: 8
Approximate Total Tokens: 4000
Tokens per Second: .64
Parse Failures: 8/8
Parse Success Rate: 0%

=== Mesh Verification ===
Verifying parameter sharding:
  ['params']/['embed_tokens']/['embedding']: shape=(151936, 896), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)
  ['params']/['layers_0']/['input_layernorm']/['weight']: shape=(896,), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None,), memory_kind=device)
  ['params']/['layers_0']/['mlp']/['down_proj']/['kernel']: shape=(4864, 896), sharding=NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec(None, 'model'), memory_kind=device)
  Input sharding: NamedSharding(mesh=Mesh('data': 2, 'model': 2, axis_types=(Auto, Auto)), spec=PartitionSpec('data', None), memory_kind=device)

Log saved to: logs/production_run_20251005_165919.log
Timing stats saved to: logs/timing_20251005_165919.txt
Predictions saved to: test_outputs/production_predictions.json
Activations saved to: test_activations/production_run_20251005_165919
